<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ë””ë²„ê¹…</title>
    <style>
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-title {
            color: #333;
            border-bottom: 2px solid #1974E8;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-button {
            background: #1974E8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #0046AA;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        .step {
            background: #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #1974E8;
            border-radius: 4px;
        }
        .url-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1 class="debug-title">ğŸ” ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ë””ë²„ê¹… ë„êµ¬</h1>
        
        <div class="step">
            <h3>1. í˜„ì¬ URL ë° í™˜ê²½ í™•ì¸</h3>
            <div id="url-info"></div>
        </div>

        <div class="step">
            <h3>2. API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸</h3>
            <input type="text" id="api-url" class="url-input" placeholder="API URL ì…ë ¥ (ì˜ˆ: api/customer/validateCoupon.php)">
            <button class="test-button" onclick="testApiEndpoint()">ğŸ”— ì—”ë“œí¬ì¸íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button class="test-button" onclick="testCouponValidation()">ğŸ« ì¿ í° ê²€ì¦ í…ŒìŠ¤íŠ¸</button>
            <button class="test-button" onclick="checkConsoleErrors()">âš ï¸ ì½˜ì†” ì˜¤ë¥˜ í™•ì¸</button>
        </div>

        <div class="step">
            <h3>3. ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ë¡œê·¸</h3>
            <button class="test-button" onclick="clearLogs()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
            <div id="log-area" class="log-area"></div>
        </div>

        <div class="step">
            <h3>4. ë¬¸ì œ í•´ê²° ê°€ì´ë“œ</h3>
            <div id="solution-guide"></div>
        </div>
    </div>

    <script>
        let logArea = document.getElementById('log-area');
        
        // ë¡œê·¸ í•¨ìˆ˜ë“¤
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            logArea.innerHTML = '';
        }

        // 1. í˜„ì¬ í™˜ê²½ ì •ë³´ í‘œì‹œ
        function displayEnvironmentInfo() {
            const urlInfo = document.getElementById('url-info');
            const currentUrl = window.location.href;
            const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
            
            urlInfo.innerHTML = `
                <strong>í˜„ì¬ URL:</strong> ${currentUrl}<br>
                <strong>Base URL:</strong> ${baseUrl}<br>
                <strong>Protocol:</strong> ${window.location.protocol}<br>
                <strong>Host:</strong> ${window.location.host}<br>
                <strong>Path:</strong> ${window.location.pathname}
            `;
            
            // API URL ìë™ ì„¤ì •
            document.getElementById('api-url').value = baseUrl + '/api/customer/validateCoupon.php';
            
            log('í™˜ê²½ ì •ë³´ í™•ì¸ ì™„ë£Œ', 'success');
        }

        // 2. API ì—”ë“œí¬ì¸íŠ¸ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testApiEndpoint() {
            const apiUrl = document.getElementById('api-url').value;
            
            if (!apiUrl) {
                log('API URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
                return;
            }
            
            log(`API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì‹œì‘: ${apiUrl}`, 'info');
            
            try {
                // OPTIONS ìš”ì²­ ë¨¼ì € í…ŒìŠ¤íŠ¸ (CORS preflight)
                log('CORS preflight ìš”ì²­ í…ŒìŠ¤íŠ¸...', 'info');
                
                const optionsResponse = await fetch(apiUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                log(`OPTIONS ì‘ë‹µ ìƒíƒœ: ${optionsResponse.status}`, optionsResponse.ok ? 'success' : 'warning');
                
                // ì‹¤ì œ POST ìš”ì²­ í…ŒìŠ¤íŠ¸
                log('POST ìš”ì²­ í…ŒìŠ¤íŠ¸...', 'info');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        couponNumber: 'TEST-COUPON-0001'
                    })
                });
                
                log(`POST ì‘ë‹µ ìƒíƒœ: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`ì‘ë‹µ í—¤ë”: ${JSON.stringify([...response.headers.entries()])}`, 'info');
                
                const responseText = await response.text();
                log(`ì‘ë‹µ ë‚´ìš©: ${responseText}`, 'info');
                
                // JSON íŒŒì‹± ì‹œë„
                try {
                    const jsonData = JSON.parse(responseText);
                    log(`JSON íŒŒì‹± ì„±ê³µ: ${JSON.stringify(jsonData, null, 2)}`, 'success');
                } catch (e) {
                    log(`JSON íŒŒì‹± ì‹¤íŒ¨: ${e.message}`, 'warning');
                }
                
            } catch (error) {
                log(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
                log(`ì˜¤ë¥˜ ìƒì„¸: ${error.stack}`, 'error');
                
                // ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ì›ì¸ ë¶„ì„
                if (error.message.includes('CORS')) {
                    log('âŒ CORS ì •ì±… ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
                } else if (error.message.includes('Failed to fetch')) {
                    log('âŒ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (404, 500 ë“±)', 'error');
                } else if (error.message.includes('NetworkError')) {
                    log('âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜ì…ë‹ˆë‹¤', 'error');
                }
            }
        }

        // 3. ì‹¤ì œ ì¿ í° ê²€ì¦ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
        async function testCouponValidation() {
            log('ì¿ í° ê²€ì¦ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ ì‹œì‘...', 'info');
            
            // validateCouponNumber í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            if (typeof validateCouponNumber === 'undefined') {
                log('âŒ validateCouponNumber í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!', 'error');
                log('validateCoupon.js íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤', 'warning');
                return;
            }
            
            log('âœ… validateCouponNumber í•¨ìˆ˜ ë°œê²¬', 'success');
            
            // í…ŒìŠ¤íŠ¸ ì¿ í°ìœ¼ë¡œ ì‹¤ì œ í•¨ìˆ˜ ì‹¤í–‰
            const testCoupon = 'VIP-2025-1234';
            log(`í…ŒìŠ¤íŠ¸ ì¿ í°ìœ¼ë¡œ ê²€ì¦ ì‹œì‘: ${testCoupon}`, 'info');
            
            validateCouponNumber(
                testCoupon,
                // ì„±ê³µ ì½œë°±
                function(couponData) {
                    log(`âœ… ì¿ í° ê²€ì¦ ì„±ê³µ: ${JSON.stringify(couponData, null, 2)}`, 'success');
                },
                // ì‹¤íŒ¨ ì½œë°±
                function(errorMessage) {
                    log(`âŒ ì¿ í° ê²€ì¦ ì‹¤íŒ¨: ${errorMessage}`, 'error');
                },
                // ë¡œë”© ì½œë°±
                function(isLoading) {
                    log(`ë¡œë”© ìƒíƒœ: ${isLoading ? 'ì‹œì‘' : 'ì™„ë£Œ'}`, 'info');
                }
            );
        }

        // 4. ì½˜ì†” ì˜¤ë¥˜ í™•ì¸
        function checkConsoleErrors() {
            log('ì½˜ì†” ì˜¤ë¥˜ ëª¨ë‹ˆí„°ë§ ì‹œì‘...', 'info');
            
            // ê¸°ì¡´ console.error ë©”ì„œë“œ ë°±ì—…
            const originalError = console.error;
            const originalWarn = console.warn;
            
            // console.error ì˜¤ë²„ë¼ì´ë“œ
            console.error = function(...args) {
                log(`ì½˜ì†” ì˜¤ë¥˜ ê°ì§€: ${args.join(' ')}`, 'error');
                originalError.apply(console, args);
            };
            
            // console.warn ì˜¤ë²„ë¼ì´ë“œ
            console.warn = function(...args) {
                log(`ì½˜ì†” ê²½ê³  ê°ì§€: ${args.join(' ')}`, 'warning');
                originalWarn.apply(console, args);
            };
            
            log('ì½˜ì†” ì˜¤ë¥˜ ëª¨ë‹ˆí„°ë§ í™œì„±í™”ë¨', 'success');
            
            // 5ì´ˆ í›„ ì›ë³µ
            setTimeout(() => {
                console.error = originalError;
                console.warn = originalWarn;
                log('ì½˜ì†” ì˜¤ë¥˜ ëª¨ë‹ˆí„°ë§ ë¹„í™œì„±í™”ë¨', 'info');
            }, 5000);
        }

        // 5. ë¬¸ì œ í•´ê²° ê°€ì´ë“œ í‘œì‹œ
        function displaySolutionGuide() {
            const solutionGuide = document.getElementById('solution-guide');
            solutionGuide.innerHTML = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-left: 4px solid #ffc107;">
                    <h4>ğŸ”§ ì¼ë°˜ì ì¸ ë¬¸ì œ ë° í•´ê²°ë°©ë²•</h4>
                    <ol>
                        <li><strong>ë„¤íŠ¸ì›Œí¬ íƒ­ì— ìš”ì²­ì´ ì•ˆ ë³´ì´ëŠ” ê²½ìš°:</strong>
                            <ul>
                                <li>JavaScript ì˜¤ë¥˜ë¡œ fetch í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ</li>
                                <li>validateCoupon.js íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•ŠìŒ</li>
                                <li>API URL ê²½ë¡œê°€ ì˜ëª»ë¨</li>
                            </ul>
                        </li>
                        <li><strong>CORS ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš°:</strong>
                            <ul>
                                <li>ì„œë²„ì—ì„œ Access-Control-Allow-Origin í—¤ë” í™•ì¸</li>
                                <li>OPTIONS ìš”ì²­ ì²˜ë¦¬ í™•ì¸</li>
                            </ul>
                        </li>
                        <li><strong>404 ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš°:</strong>
                            <ul>
                                <li>API íŒŒì¼ ê²½ë¡œ ë° ì¡´ì¬ ì—¬ë¶€ í™•ì¸</li>
                                <li>ì›¹ì„œë²„ ì„¤ì • í™•ì¸ (.htaccess ë“±)</li>
                            </ul>
                        </li>
                        <li><strong>500 ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ” ê²½ìš°:</strong>
                            <ul>
                                <li>PHP ë¬¸ë²• ì˜¤ë¥˜ í™•ì¸</li>
                                <li>ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸</li>
                                <li>ì„œë²„ ì˜¤ë¥˜ ë¡œê·¸ í™•ì¸</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <h4>ğŸš€ ì¶”ì²œ í•´ê²° ìˆœì„œ</h4>
                    <ol>
                        <li>ìœ„ í…ŒìŠ¤íŠ¸ ë²„íŠ¼ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰</li>
                        <li>ê°œë°œìë„êµ¬ Console íƒ­ì—ì„œ ì˜¤ë¥˜ ë©”ì‹œì§€ í™•ì¸</li>
                        <li>Network íƒ­ì—ì„œ ì‹¤ì œ ìš”ì²­ ìƒíƒœ í™•ì¸</li>
                        <li>API íŒŒì¼ì´ ì„œë²„ì— ì˜¬ë°”ë¥´ê²Œ ì—…ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸</li>
                        <li>ìƒëŒ€ ê²½ë¡œ ëŒ€ì‹  ì ˆëŒ€ ê²½ë¡œë¡œ í…ŒìŠ¤íŠ¸</li>
                    </ol>
                </div>
            `;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            displayEnvironmentInfo();
            displaySolutionGuide();
            log('ë””ë²„ê¹… ë„êµ¬ ì¤€ë¹„ ì™„ë£Œ', 'success');
        });

        // Network ìš”ì²­ ëª¨ë‹ˆí„°ë§ (ì‹¤í—˜ì )
        function monitorNetworkRequests() {
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                log(`ğŸŒ Fetch ìš”ì²­ ê°ì§€: ${args[0]}`, 'info');
                return originalFetch.apply(this, args)
                    .then(response => {
                        log(`ğŸ“¥ Fetch ì‘ë‹µ: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                        return response;
                    })
                    .catch(error => {
                        log(`ğŸ’¥ Fetch ì˜¤ë¥˜: ${error.message}`, 'error');
                        throw error;
                    });
            };
            log('ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ëª¨ë‹ˆí„°ë§ í™œì„±í™”', 'success');
        }

        // ëª¨ë‹ˆí„°ë§ ì¦‰ì‹œ ì‹œì‘
        monitorNetworkRequests();
    </script>
</body>
</html>